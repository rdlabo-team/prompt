name: Sentry Triage

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # Every Monday at 00:00 UTC

jobs:
  triage:
    strategy:
      matrix:
        include:
          - sentry_org: rdlabo
            sentry_projects: winecode-api,winecode-app
            github_repo: rdlabo-team/winecode
          - sentry_org: rdlabo
            sentry_projects: tipsys-api,tipsys-app
            github_repo: rdlabo-team/tipsys
          - sentry_org: rdlabo
            sentry_projects: foodlabel-api,foodlabel-app
            github_repo: rdlabo-team/foodlabel
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate instruction from template
        run: |
          sed -e 's|{{SENTRY_ORG}}|${{ matrix.sentry_org }}|g' \
              -e 's|{{SENTRY_PROJECTS}}|${{ matrix.sentry_projects }}|g' \
              -e 's|{{GITHUB_REPO}}|${{ matrix.github_repo }}|g' \
              SENTRY_TRIAGE.md > instruction.md
          cat instruction.md

      - name: Start Devin Session
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read instruction content
          ISSUE_BODY=$(cat instruction.md)
          
          # Start Devin session with instruction content directly as prompt
          DEVIN_PAYLOAD=$(jq -n \
            --arg prompt "$ISSUE_BODY" \
            --arg title "Sentry Triage - ${{ matrix.github_repo }}" \
            --argjson tags '["sentry-triage", "automated"]' \
            '{prompt: $prompt, title: $title, tags: $tags}')
          
          DEVIN_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            https://api.devin.ai/v1/sessions \
            -H "Authorization: Bearer $DEVIN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$DEVIN_PAYLOAD")
          
          DEVIN_HTTP_CODE=$(echo "$DEVIN_RESPONSE" | tail -n1)
          DEVIN_BODY_RESPONSE=$(echo "$DEVIN_RESPONSE" | sed '$d')
          
          echo "Devin API Response (HTTP $DEVIN_HTTP_CODE): $DEVIN_BODY_RESPONSE"
          
          if [ "$DEVIN_HTTP_CODE" = "200" ] || [ "$DEVIN_HTTP_CODE" = "201" ]; then
            SESSION_URL=$(echo "$DEVIN_BODY_RESPONSE" | jq -r '.url')
            if [ "$SESSION_URL" != "null" ] && [ -n "$SESSION_URL" ]; then
              echo "Devin Session: $SESSION_URL"
              
              # Comment session URL on issue #22 in rdlabo-team/prompt
              COMMENT_PAYLOAD=$(jq -n \
                --arg body "Devin session started for ${{ matrix.github_repo }}: $SESSION_URL" \
                '{body: $body}')
              
              COMMENT_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Content-Type: application/json" \
                https://api.github.com/repos/rdlabo-team/prompt/issues/22/comments \
                -d "$COMMENT_PAYLOAD")
              
              COMMENT_HTTP_CODE=$(echo "$COMMENT_RESPONSE" | tail -n1)
              if [ "$COMMENT_HTTP_CODE" = "201" ]; then
                echo "Posted comment to issue #22"
              else
                COMMENT_BODY=$(echo "$COMMENT_RESPONSE" | sed '$d')
                echo "Warning: Failed to post comment to issue #22. HTTP status: $COMMENT_HTTP_CODE"
                echo "Response: $COMMENT_BODY"
              fi
            else
              echo "Warning: Session URL not found in Devin API response"
            fi
          else
            echo "Warning: Devin API call failed with status $DEVIN_HTTP_CODE"
            echo "Response: $DEVIN_BODY_RESPONSE"
          fi
