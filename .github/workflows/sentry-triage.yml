name: Sentry Triage

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # Every Monday at 00:00 UTC

jobs:
  triage:
    strategy:
      matrix:
        include:
          - sentry_org: rdlabo
            sentry_projects: winecode-api,winecode-app
            github_repo: rdlabo-team/winecode
          - sentry_org: rdlabo
            sentry_projects: tipsys-api,tipsys-app
            github_repo: rdlabo-team/tipsys
          - sentry_org: rdlabo
            sentry_projects: foodlabel-api,foodlabel-app
            github_repo: rdlabo-team/foodlabel
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate instruction from template
        run: |
          sed -e 's|{{SENTRY_ORG}}|${{ matrix.sentry_org }}|g' \
              -e 's|{{SENTRY_PROJECTS}}|${{ matrix.sentry_projects }}|g' \
              -e 's|{{GITHUB_REPO}}|${{ matrix.github_repo }}|g' \
              SENTRY_TRIAGE.md > instruction.md
          cat instruction.md

      - name: Create GitHub Issue for Devin
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: ${{ matrix.github_repo }}
          title: "Sentry 高優先度・未修正 Issue を収集して GitHub Issue 化（Devin 用指示書）"
          content-filepath: instruction.md
          labels: devin
