name: Sentry Triage

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # Every Monday at 00:00 UTC

jobs:
  triage:
    strategy:
      matrix:
        include:
          - sentry_org: rdlabo
            sentry_projects: winecode-api,winecode-app
            github_repo: rdlabo-team/winecode
          - sentry_org: rdlabo
            sentry_projects: tipsys-api,tipsys-app
            github_repo: rdlabo-team/tipsys
          - sentry_org: rdlabo
            sentry_projects: foodlabel-api,foodlabel-app
            github_repo: rdlabo-team/foodlabel
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate instruction from template
        run: |
          sed -e 's|{{SENTRY_ORG}}|${{ matrix.sentry_org }}|g' \
              -e 's|{{SENTRY_PROJECTS}}|${{ matrix.sentry_projects }}|g' \
              -e 's|{{GITHUB_REPO}}|${{ matrix.github_repo }}|g' \
              SENTRY_TRIAGE.md > instruction.md
          cat instruction.md

      - name: Start Devin Session
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create GitHub Issue with the instruction
          ISSUE_BODY=$(cat instruction.md)
          ISSUE_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ matrix.github_repo }}/issues \
            -d "{
              \"title\": \"Sentry 高優先度・未修正 Issue を収集して GitHub Issue 化（Devin 用指示書）\",
              \"body\": $(echo "$ISSUE_BODY" | jq -Rs .),
              \"labels\": [\"devin\"]
            }")
          
          ISSUE_NUMBER=$(echo $ISSUE_RESPONSE | jq -r '.number')
          ISSUE_URL=$(echo $ISSUE_RESPONSE | jq -r '.html_url')
          echo "Created issue: $ISSUE_URL"
          
          # Start Devin session
          RESPONSE=$(curl -s -X POST https://api.devin.ai/v1/sessions \
            -H "Authorization: Bearer $DEVIN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"prompt\": \"$ISSUE_URL の指示に従ってタスクを実行してください。\",
              \"title\": \"Sentry Triage - Scheduled Run\",
              \"tags\": [\"sentry-triage\", \"automated\"]
            }")

          echo "Response: $RESPONSE"
          SESSION_URL=$(echo $RESPONSE | jq -r '.url')
          echo "Devin Session: $SESSION_URL"

          # Comment session URL on issue #22 in rdlabo-team/prompt
          if [ "$SESSION_URL" != "null" ]; then
            curl -s -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/rdlabo-team/prompt/issues/22/comments \
              -d "{\"body\": \"Devin session started for ${{ matrix.github_repo }}: $SESSION_URL\"}"
          fi
